[TOC]

# 分布式调度

​	两大任务

 - 任务调度
    - 大量计算任务
    - 任务如何切分
    - 数据如何分割/运算
    - 监控运算状态
- 资源调度
  - 供给方
  - 不同业务间平衡资源 
  - 支持优先级抢占
- 市面上分布式调度系统
  - Hadoop MR
    - 主从架构
    - JobTracker单点问题，规模扩展瓶颈
    - JobTracker单点，没有failover,容错性差
    - 不利于功能扩展，不同任务采用不同的调度策略，热拔插
  - YARN
    - 将资源调度与任务调度区分
    - 仅支持内存级别资源调度， cpu, disk, net
    - 资源交互性能，会归还资源，反复分配
  - Mesos
    - scheduler与mesos master之间不能描述精确的资源需求
    - 一次资源分配需要两次通信交互(offer & accept)，调度效率低
    - 不支持资源抢占
  - aliyun-fuxi

## 任务调度

数据量增大时怎么办？

- 多线程
- 多进程

单台物理机器内存是有上限的

对海量数据的并发处理

- MR

  - 统计图书馆中所有属于自然科学的书本
  - 统计全部学生的成绩的平均分
  - 系统的日志分析
  - 网页搜索中的PageRank

- 技术要点

  - 数据本地化Locality

    - 将instance分配到对应数据最多的node
    - 不同的instance做到负载均衡

  - 数据shuffle MR, 抽象成一个partion函数，重载一个hash函数实现下面的三种

    - 1:1
    - 1:N
    - M:N

  - Instance重跑和BackUp instance

    - 硬件故障 / 软件故障

      - 重试 : 在另一机器上重跑
      - 长尾问题: 机器在性能和处理能力上存在差异，一个跑的慢，在另一台机器上跑相同数据，取最先完成的instance的结果
        - 触发条件
          - 运行时间超过其它Instance的平均运行时间
          - 数据处理速度低于其它instance平均值
          - 已完成的instance比例

      ​

## 资源调度

资源调度问题: 将cpu, memory, disk等资源合理分配给任务job

目标:

- 最大化集群资源利用率
- 最小化任务的等待时间
- 能支持资源配额
- 支持任务抢占

设计:

- 策略之优先级(Priority)

  - 每个job有priority值，整数值，值越小优先级越高，越靠前

  - 相同优先级按提交时间，先提交高优先级

  - 优先分配高优先级的job，剩余分配次优先级job

  - 抢占

    - 从最低优先级任务强制收回，分配给紧急任务
    - 抢占递归，直到被强占优先级不高于紧急任务

  - ​
- 策略之公平调度
  - 按优先级分组，同一优先级组内平均分配
  - 有剩余资源再去下一优先级组分配
- 策略之配额quota
  - 多个任务组成group，按不同的业务区分
  - 每个group的job所分配资源付费
  - 最低保障资源和max资源，类似Executors.Threadpool, coresize, maxsize, maxsize在idle之后可以被回收

## 容错机制

​	故障

 - 硬件故障
   - 磁盘
   - 主板
   - 内存条
- 软件故障
  - 存在BUG
  - 内存访问越界
  - 进程crash
  - 整机宕机
- 故障恢复
  - 正在运行的任务不应该被中断
  - 对用户是透明的
  - 自动故障恢复
  - 系统恢复时保持可用性
- 任务调度的故障恢复
  - worker failover 会被app maser在另一台机器上重试
  - app master failover 会被重启，因有snapshot, checkpoint, 会定期保存在磁盘上
- 资源调度的failover
  - soft state (软状态)， 重新发送一份过来
    - 机器列表
    - 每个app master的资源请求
  - hard state(硬状态)
    - 用户提交的配置信息

## 规模挑战

​	资源增多，性能不是线性下降的过程，因为当节点更多时，节点间的通信和调度开销将成为瓶颈

分布式系统设计目标之一就是横向扩展scale-out

- 增量的消息通讯
- 异步持续多线程
- 设计要点
  - 多线程异步
    - 独立泳道： 不同线程池处理不同任务
  - 增量资源调度



## 安全与性能隔离

核心问题： 安全隔离/性能隔离

- 如何鉴别消息是否合法： 集群
  - capability访问控制：攻击性和恶意程序不会扰乱集群运行状态
    - 需要预先知道集群上有哪些用户，在集群部署前
  - 动态: 不知道未来运行什么作业
    - token方式： 动态口令
- 多进程之间如何安全隔离： 单机 
  - 进程级别沙箱(sandbox)隔离
- 性能隔离
  - vm(kvm, xen) , docker(lxc+虚拟化), LXC

## 分布式调度的发展方向

- 在线应用

  - 网页服务: 进程起来以后不会退出，输入数据没有明显的起止节点

- 离线处理

  - mapreduce：输入数据固定的，就是一个文件或文件中的某一段

- 在线应用与离线任务混跑

  - 在线应用对响应时间(Latency)要求很高
  - 离线应用对调度的吞吐率(Throughput)要求高  (cpu, net io , disk io)
  - 如何将整个公司内部的在线业务与离线业务并存起来，最大化的利用集群的物理资源，同时，又不干扰在线应用对延迟的要求
  - 电商集群
    - 如何进行电商和离线任务混跑: 超迈
      - 电商集群处在休息状态下，能够在很多在线的进程机器上，往上面调度一些离线的计算，能够将剩余的CPU和内存的计算能力利用起来
    - 实时计算
      - 如何做好batch（批处理)
      - 如何做到容错，规模
        - 大数据实时分析 spark / storm / flink
        - bi bw
      - 通过集群管理员的配置
      - 通过发现集群白天使用量和晚上使用量的配置
        - 什么时候该缩减worker的数量？
        - 什么时候该增加worker的数量?
        - 弹性调节:
          - 在业务不繁忙时，释放集群资源 ，在集群业务量上来的时候，能够要到资源，并且拉起一组常驻进程
        - 更大规模，更多并发量
          - 时间维度， 有些白天，有点晚上
          - 资源维度 cpu, 内存
          - 如何来支撑
          - 如何 在做到资源的调度
          - 如何来做到更快的资源调度
          - 如何来做到更大规模的任务调度
          - ​

  ​

  ​