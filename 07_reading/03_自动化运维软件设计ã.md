[TOC]

# 1. 什么是自动化运维

运维是批地一些已经搭建好的网络软硬件进行维护。



## 1.1 硬件运维和软件运维

### 1.1.1 小故事之一 ----电脑专家

### 1.1.2 小故事之二 ---- 你居然不会修电脑

###  1.1.3 硬件运维与软件运维

硬件运维可以理解为对基础设施的运维，包括机房的设备和电脑设备，比如对机房的备用电源、空调、主机上的硬盘、内存这些物理设备的维护。

软件运维包括系统运维和应用运维。系统运维指的是对操作系统、数据库、中间件等的监控和维护，这些系统是介于设备和应用之间的。应用运维是对业务系统的运维，例如企业内部的oa, erp等业务系统。

## 1.2 软件运维的主要问题

### 1.2.1 设备数量太多

### 1.2.2 系统异构性大

### 1.2.3 虚拟化的成熟带来更大的困难

CMDB （configuration management database) 存储管理企业IT架构中设备的各种配置信息，它与所有服务支持和服务交付流程都紧密关联，支持这些流程的运转，发挥配置信息的价值，同时依赖于相关流程以保证数据的准确性



## 1.3 运维常用工具

### 1.3.1 Puppet

用ruby实现的c/s类型集中化配置软件。所有的客户端都会周期性地向服务器发送请求，获取最新配置，保证配置信息的同步。默认情况下每半个小时会连接一次服务器，下载最新的配置文件，并且严格按照配置文件来配置服务器。

可扩展性上，puppet有一套自己的dsl语言

### 1.3.2 SaltStack

采用python开发的集中化运维软件，内置许多模块，包括安装软件，配置参数，启停服务等。支持的操作系统十分丰富。

设计上，支持master主动推送配置和minion定时拉取配置的方式，这点与puppet类似。同时，它也支持远程命令的并行执行，自带了许多日常执行模块，可以把saltStack看作ansible和puppet的混合版本。并且saltstack支持saltssh的方式。可以让我们无需使用agent就能够对主机进行批量操作。当我们希望saltstack能够具备更好的扩展性，以及更好地使用saltstack本身提供的模块时，可以在客户机安装salt minion来进行主机的集中化运维

### 1.3.3 Ansible

使用python设计的通过ssh方式对主机信息进行集中化运维的软件，纯ssh方式，主机上不需要安装任何agent

## 1.4 自动化运维

有了puppet, ansible和saltstack这样的工具，我们已经可以轻松的做到集中化运维了，一些集中化的部署、集中化的重启的动作都可以轻易完成。但是我们的运维过程却还没有达到自动化的水平。例如，我们现在维护了200台设备，a主机上跑了一个业务系统，由于程序设计的原因，总是会不定期地出现应用服务器崩溃的问题，但是开发商由于技术问题一时半会解决不了，这个时候运维工程师就只能盯着自己的手机短信，就得熟练地打开securityCRT登陆主机，然后熟练地敲下restart命令。没几天后，有用户报故障说业务系统B无法上传文件了，再次熟练地登陆那台机器，发现本来就不大的磁盘被系统写日志文件给写满了，于是工程师又熟练地敲下了rm命令删掉了一些日志文件，一段时间后，又有用户报障....



虽然有那么多集中化运维工具可以选择，但是不骨一款能帮它们减轻负担。因为这些故障往往是非集中化的操作，解决的方法都是靠运维工程师在日常运维的过程中对某些场景积累下来的特定的经验，这种情况下无论使用哪一种集中化运维工具，和我们直接通过ssh或者远程桌面操作其实没有多大的区别。问题出现一两次，我们可以登陆出现故障的主机进行处理，但是次数多了呢，然后我们就只有在每次故障出现之后都重复这些运维操作吗？



这个时候我们需要把运维从集中化提升到自动化的水平了，而运维自动化，是一个对单点发生的故障运维知识沉淀的过程。



如果是多点发生且重复的故障，我们通过集中化运维工具就可以很好地解决问题，但是面对单点故障，集中化运维工具并不能并不能产生很好的效果。



为什么说是知识的沉淀？假设出现我们上面所说的B主机磁盘写满导致业务系统无法上传文件这样的故障，在排查后已经把问题定位清楚并且有了解决方法了。对于运维来说，这个过程就是一个经验沉淀的过程，然后就可以把这个知识积累下来，去寻找一些方法使这个过程自动化。



对于这种由监控所驱动的自动化运维，一般由四个步骤组成，分别是了解，决策、执行、还有记录与反馈。



第一步是要对设备、业务等我们所关注的对象进行监控。我们可以把监控看作一个了解信息的过程，只有当我们了解了实际情况后，我们才能进行后续的操作。



第二步是决策。决策这个过程定义了在什么情况下我们应该执行什么操作的规则。例如，哪些主机磁盘满了需要做日志文件删除的操作，哪些主机磁盘满了需要做归档日志文件的操作，这些都是需要在决策过程中去定义的。



第三步是执行，我们根据之前的规则做出相应的决策之后，然后就可以开始执行相应的运维操作了。这个过程我们需要关注的是如何可以屏蔽异构的操作系统给我们带来的不便，也就是怎么样能够让异构操作系统的差异对执行的动作来说是透明的。



最后一步是记录和反馈。在完成了具体的维护操作之后，我们需要有一套记录的机制，用于查询究竟在什么时候做出了什么样的运维操作，并且在执行完成之后能够通过短信、邮件等方式给运维人员发出通知，让运维人员能够在执行完之后马上知道系统究竟执行了哪些运维操作，结果是怎样的。



对于了解、决策、记录和反馈这几个过程来说，目前开源软件中做得最好的就算zabbix了，它有丰富的告警策略、多种设备监控、强大的动作管理的功能，并且还具备了十分强大的扩展能力，而对于执行这个动作，虽然zabbix也可以做到，但是zabbix没有对异构操作系统进行集中管理的能力，并且也没有人为它封装相应的运维模块，所以这个环节一般情况下更倾向于选择像saltstack, ansible或者puppet这些集中化运维工具





## 1.5 小结

更多的自动化操作，更少的人工干预

# 2. 集中化运维利器

## 2.1 环境准备 

## 2.2 安装ansible

### 2.2.1 使用centos的epel源进行安装

### 2.2.2 使用easy_install安装ansible

## 2.3 ansible基础

### 2.3.1 资产配置

### 2.3.2 执行命令

## 2.3.3 指定目标主机

###  2.3.4 常用命令示例

## 2.4 ansible常用模块

### 2.4.1 文件管理模块

## 2.4.2 命令执行模块